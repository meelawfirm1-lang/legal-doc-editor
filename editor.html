<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تحرير العريضة</title>

  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Amiri', serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1f2937;
      color: white;
      padding: 15px;
      text-align: center;
    }
    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 {
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 5px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      font-family: 'Amiri', serif;
      font-size: 16px;
    }
    textarea {
      min-height: 100px;
    }
    button {
      padding: 12px 20px;
      font-family: 'Amiri', serif;
      font-size: 16px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }
  </style>
</head>
<body>

<header>
  <h1>✍️ تحرير العريضة القانونية</h1>
</header>

<main>
  <h2 id="docTitle">تحميل النموذج...</h2>

  <form id="editorForm"></form>

  <div class="actions">
    <button class="btn-secondary" onclick="goBack()">رجوع</button>
    <button class="btn-primary" onclick="goPreview()">معاينة العريضة</button>
  </div>
</main>

<script>
  const templatePath = 'templates/civil/دعوى_اخلاء_للفشل_في_السداد.json';
  let templateData = null;

  fetch(templatePath)
    .then(res => res.json())
    .then(data => {
      templateData = data;
      document.getElementById('docTitle').innerText = data.title;
      buildForm(data);
    })
    .catch(() => {
      document.getElementById('docTitle').innerText = 'تعذر تحميل النموذج';
    });

  function buildForm(template) {
    const form = document.getElementById('editorForm');

    // أطراف الدعوى
    addSection(form, 'بيانات المدعي');
    template.parties.plaintiff.fields.forEach(f => addField(form, f));

    addSection(form, 'بيانات المدعى عليه');
    template.parties.defendant.fields.forEach(f => addField(form, f));

    // الوقائع المتغيرة
    addSection(form, 'بيانات العقار والأجرة');
    const dynamicFields = extractVariables(template.body.facts);
    dynamicFields.forEach(name => addField(form, { name, label: name, type: 'text', required: true }));

    // المطالبات المالية
    addSection(form, 'الطلبات المالية');
    ['arrears_amount','fees_amount','case_value'].forEach(name => {
      addField(form, { name, label: name, type: 'text', required: true });
    });
  }

  function addSection(form, title) {
    const h = document.createElement('h2');
    h.innerText = title;
    form.appendChild(h);
  }

  function addField(form, field) {
    const div = document.createElement('div');
    div.className = 'form-group';

    const label = document.createElement('label');
    label.innerText = field.label || field.name;

    let input;
    if (field.type === 'textarea') {
      input = document.createElement('textarea');
    } else {
      input = document.createElement('input');
      input.type = 'text';
    }

    input.name = field.name;
    if (field.required) input.required = true;

    div.appendChild(label);
    div.appendChild(input);
    form.appendChild(div);
  }

  function extractVariables(facts) {
    const vars = new Set();
    facts.forEach(f => {
      const matches = f.text.match(/{{(.*?)}}/g) || [];
      matches.forEach(m => vars.add(m.replace(/[{}]/g, '')));
    });
    return Array.from(vars);
  }

  function goPreview() {
    const data = {};
    new FormData(document.getElementById('editorForm')).forEach((v, k) => data[k] = v);
    localStorage.setItem('docData', JSON.stringify(data));
    localStorage.setItem('templateData', JSON.stringify(templateData));
    window.location.href = 'preview.html';
  }

  function goBack() {
    window.location.href = 'index.html';
  }
</script>

</body>
</html>
